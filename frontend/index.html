<!--
  Frontend completo del ASME Pressure Vessel Extractor.
  - Finalidad: Dual upload zone (Type1/Type2) con drag&drop, muestra 11 campos
    extraidos con warnings, historial paginado con eliminacion. Embebible en iframe.
  - Consume: API backend (POST /api/upload, GET /api/records, DELETE /api/records/{id})
  - Consumido por: main.py (servido como static file), Glide (via iframe)
-->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASME Pressure Vessel Extractor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; color: #1a1a2e; min-height: 100vh; }

        .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 20px 32px; }
        .header h1 { font-size: 1.4rem; font-weight: 600; }
        .header p { font-size: 0.85rem; opacity: 0.7; margin-top: 4px; }

        .container { max-width: 1200px; margin: 0 auto; padding: 24px 16px; }

        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 32px; }

        .upload-zone {
            border: 2px dashed #cbd5e1; border-radius: 12px; padding: 32px 24px;
            text-align: center; cursor: pointer; transition: all 0.2s;
            background: white; position: relative;
        }
        .upload-zone:hover { border-color: #3b82f6; background: #f8fafc; }
        .upload-zone.dragover { border-color: #3b82f6; background: #eff6ff; transform: scale(1.01); }
        .upload-zone.processing { border-color: #f59e0b; background: #fffbeb; pointer-events: none; }
        .upload-zone.error { border-color: #ef4444; background: #fef2f2; }

        .upload-zone .icon { font-size: 2.5rem; margin-bottom: 12px; }
        .upload-zone h3 { font-size: 1rem; margin-bottom: 6px; color: #1e293b; }
        .upload-zone p { font-size: 0.8rem; color: #64748b; }
        .upload-zone input { display: none; }

        .spinner { display: none; margin: 12px auto; width: 32px; height: 32px; border: 3px solid #e2e8f0; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; }
        .processing .spinner { display: block; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .status-msg { margin-top: 10px; font-size: 0.8rem; font-weight: 500; }
        .status-msg.success { color: #16a34a; }
        .status-msg.error { color: #dc2626; }

        .result-panel {
            background: white; border-radius: 12px; padding: 24px;
            margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); display: none;
        }
        .result-panel.visible { display: block; }
        .result-panel h2 { font-size: 1.1rem; margin-bottom: 16px; color: #1e293b; }

        .result-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
        .result-field { background: #f8fafc; border-radius: 8px; padding: 12px 16px; border-left: 3px solid #3b82f6; }
        .result-field.warning { border-left-color: #f59e0b; background: #fffbeb; }
        .result-field label { display: block; font-size: 0.7rem; text-transform: uppercase; color: #64748b; font-weight: 600; letter-spacing: 0.5px; }
        .result-field .value { font-size: 0.95rem; font-weight: 500; margin-top: 2px; color: #1e293b; }
        .result-field .raw { font-size: 0.7rem; color: #94a3b8; margin-top: 2px; }

        .warnings-bar { background: #fffbeb; border: 1px solid #fde68a; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; font-size: 0.8rem; color: #92400e; }

        .history-section { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .history-section h2 { font-size: 1.1rem; margin-bottom: 16px; color: #1e293b; }

        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { text-align: left; padding: 10px 12px; background: #f1f5f9; color: #475569; font-weight: 600; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.5px; }
        td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; color: #334155; }
        tr:hover td { background: #f8fafc; }

        .btn-delete { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; }
        .btn-delete:hover { background: #fef2f2; }

        .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; }
        .badge.type1 { background: #dbeafe; color: #1e40af; }
        .badge.type2 { background: #fce7f3; color: #9d174d; }

        .empty-state { text-align: center; padding: 40px; color: #94a3b8; }

        @media (max-width: 768px) {
            .upload-grid { grid-template-columns: 1fr; }
            .result-grid { grid-template-columns: 1fr; }
            table { font-size: 0.7rem; }
            th, td { padding: 8px 6px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ASME Pressure Vessel Data Extractor</h1>
        <p>Suba un certificado PDF para extraer datos automaticamente</p>
    </div>

    <div class="container">
        <div class="upload-grid">
            <div class="upload-zone" id="zone-type1" onclick="document.getElementById('file-type1').click()">
                <div class="icon">ðŸ“‹</div>
                <h3>FORM U-1A (&lt; 10 anos)</h3>
                <p>Formulario ASME directo del fabricante<br>Arrastre o haga click para subir</p>
                <input type="file" id="file-type1" accept=".pdf">
                <div class="spinner"></div>
                <div class="status-msg" id="status-type1"></div>
            </div>

            <div class="upload-zone" id="zone-type2" onclick="document.getElementById('file-type2').click()">
                <div class="icon">ðŸ“‘</div>
                <h3>Certificado de Inspeccion (&gt; 10 anos)</h3>
                <p>Certificado completo con U-1A embebido<br>Arrastre o haga click para subir</p>
                <input type="file" id="file-type2" accept=".pdf">
                <div class="spinner"></div>
                <div class="status-msg" id="status-type2"></div>
            </div>
        </div>

        <div class="result-panel" id="result-panel">
            <h2>Resultado de Extraccion: <span id="result-filename"></span></h2>
            <div class="warnings-bar" id="warnings-bar" style="display:none"></div>
            <div class="result-grid" id="result-grid"></div>
        </div>

        <div class="history-section">
            <h2>Historial de Registros</h2>
            <div id="history-content">
                <div class="empty-state">Cargando...</div>
            </div>
        </div>
    </div>

    <script>
        const API = window.location.origin;

        function esc(str) {
            if (str === null || str === undefined) return null;
            const d = document.createElement('div');
            d.textContent = String(str);
            return d.innerHTML;
        }
        const FIELD_LABELS = {
            fabricante: 'Fabricante',
            asme_code_edition: 'Edicion ASME',
            mawp_psi: 'MAWP (PSI)',
            hydro_test_pressure_psi: 'Presion Hidro (PSI)',
            material_cuerpo: 'Material Cuerpo',
            espesor_cuerpo_mm: 'Espesor Cuerpo (mm)',
            longitud_cuerpo_m: 'Longitud Cuerpo (m)',
            diametro_interior_m: 'Diametro Interior (m)',
            material_cabezales: 'Material Cabezales',
            espesor_cabezales_mm: 'Espesor Cabezales (mm)',
            fecha_certificacion: 'Fecha Certificacion',
        };
        const RAW_MAP = {
            mawp_psi: 'raw_mawp',
            hydro_test_pressure_psi: 'raw_hydro_test_pressure',
            espesor_cuerpo_mm: 'raw_espesor_cuerpo',
            longitud_cuerpo_m: 'raw_longitud_cuerpo',
            diametro_interior_m: 'raw_diametro_interior',
            espesor_cabezales_mm: 'raw_espesor_cabezales',
        };

        function setupZone(zoneId, inputId, pdfType) {
            const zone = document.getElementById(zoneId);
            const input = document.getElementById(inputId);
            const statusEl = document.getElementById('status-' + pdfType);

            ['dragenter', 'dragover'].forEach(evt => {
                zone.addEventListener(evt, e => { e.preventDefault(); zone.classList.add('dragover'); });
            });
            ['dragleave', 'drop'].forEach(evt => {
                zone.addEventListener(evt, e => { e.preventDefault(); zone.classList.remove('dragover'); });
            });

            zone.addEventListener('drop', e => {
                const file = e.dataTransfer.files[0];
                if (file) uploadFile(file, pdfType, zone, statusEl);
            });

            input.addEventListener('change', () => {
                const file = input.files[0];
                if (file) uploadFile(file, pdfType, zone, statusEl);
                input.value = '';
            });
        }

        async function uploadFile(file, pdfType, zone, statusEl) {
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                statusEl.textContent = 'Solo archivos PDF';
                statusEl.className = 'status-msg error';
                return;
            }

            zone.classList.add('processing');
            zone.classList.remove('error');
            statusEl.textContent = 'Procesando... (puede tomar 5-10s)';
            statusEl.className = 'status-msg';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(`${API}/api/upload/${pdfType}`, { method: 'POST', body: formData });
                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.detail || 'Error desconocido');
                }

                statusEl.textContent = 'Extraccion exitosa';
                statusEl.className = 'status-msg success';
                showResult(data.record);
                loadHistory();
            } catch (err) {
                zone.classList.add('error');
                statusEl.textContent = err.message;
                statusEl.className = 'status-msg error';
            } finally {
                zone.classList.remove('processing');
            }
        }

        function showResult(record) {
            const panel = document.getElementById('result-panel');
            const grid = document.getElementById('result-grid');
            const warningsBar = document.getElementById('warnings-bar');

            document.getElementById('result-filename').textContent =
                record.original_filename + ' (' + record.pdf_type + ')';

            const warnings = record.extraction_warnings || [];
            if (warnings.length > 0) {
                warningsBar.style.display = 'block';
                warningsBar.innerHTML = '<strong>Advertencias:</strong> ' + warnings.join(' | ');
            } else {
                warningsBar.style.display = 'none';
            }

            const warningFields = new Set(
                warnings.map(w => { const m = w.match(/'([^']+)'/); return m ? m[1] : ''; })
            );

            grid.innerHTML = '';
            for (const [key, label] of Object.entries(FIELD_LABELS)) {
                const val = record[key];
                const isWarning = warningFields.has(key);
                const rawKey = RAW_MAP[key];
                const rawVal = rawKey ? record[rawKey] : null;

                const div = document.createElement('div');
                div.className = 'result-field' + (isWarning ? ' warning' : '');
                div.innerHTML =
                    '<label>' + esc(label) + '</label>' +
                    '<div class="value">' + (val !== null && val !== undefined ? esc(val) : 'â€”') + '</div>' +
                    (rawVal ? '<div class="raw">Original: ' + esc(rawVal) + '</div>' : '');
                grid.appendChild(div);
            }

            // Extra fields
            for (const [key, label] of [['serial_number', 'Numero de Serie'], ['vessel_type', 'Tipo Recipiente']]) {
                const div = document.createElement('div');
                div.className = 'result-field';
                div.innerHTML = '<label>' + esc(label) + '</label><div class="value">' + (esc(record[key]) || 'â€”') + '</div>';
                grid.appendChild(div);
            }

            panel.classList.add('visible');
        }

        async function loadHistory() {
            const container = document.getElementById('history-content');
            try {
                const res = await fetch(`${API}/api/records?limit=20`);
                const data = await res.json();

                if (data.records.length === 0) {
                    container.innerHTML = '<div class="empty-state">No hay registros aun. Suba un PDF para comenzar.</div>';
                    return;
                }

                let html = '<table><thead><tr>' +
                    '<th>ID</th><th>Tipo</th><th>Archivo</th><th>Serie</th>' +
                    '<th>Fabricante</th><th>MAWP</th><th>Fecha Cert.</th><th></th>' +
                    '</tr></thead><tbody>';

                for (const r of data.records) {
                    const badge = r.pdf_type === 'TYPE_1' ? 'type1' : 'type2';
                    const typeLabel = r.pdf_type === 'TYPE_1' ? 'U-1A' : 'Cert. Insp.';
                    html += '<tr>' +
                        '<td>' + r.id + '</td>' +
                        '<td><span class="badge ' + badge + '">' + typeLabel + '</span></td>' +
                        '<td>' + (esc(r.original_filename) || 'â€”') + '</td>' +
                        '<td>' + (esc(r.serial_number) || 'â€”') + '</td>' +
                        '<td>' + (esc(r.fabricante) || 'â€”') + '</td>' +
                        '<td>' + (r.mawp_psi ? esc(r.mawp_psi) + ' PSI' : 'â€”') + '</td>' +
                        '<td>' + (esc(r.fecha_certificacion) || 'â€”') + '</td>' +
                        '<td><button class="btn-delete" onclick="deleteRecord(' + r.id + ')">Eliminar</button></td>' +
                        '</tr>';
                }
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch {
                container.innerHTML = '<div class="empty-state">Error al cargar historial</div>';
            }
        }

        async function deleteRecord(id) {
            if (!confirm('Eliminar registro #' + id + '?')) return;
            try {
                await fetch(`${API}/api/records/${id}`, { method: 'DELETE' });
                loadHistory();
                document.getElementById('result-panel').classList.remove('visible');
            } catch { /* ignore */ }
        }

        setupZone('zone-type1', 'file-type1', 'type1');
        setupZone('zone-type2', 'file-type2', 'type2');
        loadHistory();
    </script>
</body>
</html>
